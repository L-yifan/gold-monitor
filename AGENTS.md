# OpenCode Agent 指南 (AGENTS.md)

本文件为操作此代码库的 AI 代理（如 OpenCode, Cursor, Copilot）提供规范说明。在修改代码前，请务必阅读并遵守以下约定。

## 1. 项目概览

- **名称**: 国内金价实时监控系统 (Au99.99)
- **架构**: 
  - **后端**: Python Flask (单文件 `app.py` 为核心)
  - **前端**: Vue 3 (CDN 引入) + Tailwind CSS + Chart.js，集成于 `templates/index.html`
  - **数据持久化**: 轻量级 JSON 文件 (`data.json`) 存储
- **核心逻辑**: 
  - 监控上海黄金交易所 Au99.99 价格
  - 计算扣除手续费（默认 0.5%）后的止盈位
  - 后台多源轮询采集与熔断机制

## 2. 构建与指令

### 环境准备
```bash
# 安装依赖
pip install -r requirements.txt
```

### 运行应用
```bash
# 启动 Flask 服务 (包含后台抓取线程)
python app.py
```

### 测试与质量控制
目前项目暂无自动化测试集，功能验证需遵循以下流程：
- **Lint 检查**: `flake8 app.py --max-line-length=120`
- **语法检查**: `python -m py_compile app.py`
- **手动验证**:
  1. 启动服务后访问 `http://localhost:5000`
  2. 验证实时价格是否跳动 (WebSocket/Polling)
  3. 验证图表是否显示历史走势
  4. 验证手动记录功能是否写入 `data.json`

## 3. 代码风格与规范

### Python 后端 (`app.py`)
1. **命名规范**: 
   - 变量与函数: `snake_case` (如 `fetch_gold_price`)
   - 常量: `UPPER_SNAKE_CASE` (如 `DATA_SOURCES`)
2. **结构布局**: 
   - 必须保持 `# ==================== 模块名 ====================` 分隔符。
   - 顺序：Imports -> Config -> Global Vars -> Helper Functions -> Routes -> Main。
3. **并发与安全**:
   - **全局锁**: 涉及 `price_history` 或 `manual_records` 的读写必须使用 `with lock:`。
   - **锁类型**: 必须使用 `threading.RLock()` 以支持同一线程内的重入（如后台线程调用保存函数）。
   - **后台线程**: 必须设置为 `daemon=True`，防止主进程退出时挂起。
4. **数据管理**:
   - **清理策略**: 每次保存前必须调用 `cleanup_expired_data()`。
     - 历史价格保留 24 小时
     - 手动记录保留 7 天
   - **缓存优先**: `/api/price` 接口应优先返回内存缓存，仅在缓存失效（>30s）时触发实时抓取。

### 前端 (`templates/index.html`)
1. **技术栈**: 单文件 Vue 3 (Options API) + Tailwind CSS + Chart.js。
2. **Jinja2 兼容**: Vue 模板代码必须包裹在 `{% raw %}` ... `{% endraw %}` 中。
3. **图表渲染 (Chart.js)**:
   - **时间轴**: X 轴必须配置为 `type: 'linear'` 以真实反映时间跨度。
   - **断档处理**: 相邻数据点间隔超过 10 分钟时，必须插入 `{x: timestamp, y: null}` 以断开连线。
   - **布局**: `layout.padding.right` 至少保留 110px，用于侧边栏标签展示。
4. **样式**: 
   - **红涨绿跌**: `text-red-500` (涨), `text-green-500` (跌)。
   - **价格标签**: 使用实心高对比度色块，白色文字，放置于图表右侧空白区。

## 4. 核心业务逻辑参考

### 关键常量
- **手续费率 (`fee_rate`)**: `0.005` (0.5%)
- **数据保留**: 24 小时 (History), 7 天 (Records)

### 计算公式
1. **目标卖出价 (Sell Price)**:
   - `sell_price = buy_price * (1 + target_profit_rate) / (1 - fee_rate)`
2. **实际收益率 (Actual Profit Rate)**:
   - `profit_rate = (current_price * (1 - fee_rate) - buy_price) / buy_price * 100`

## 5. 开发禁忌 (DO NOT)
- **禁止** 使用普通 `threading.Lock()` 替换 `RLock()` (会导致死锁)。
- **禁止** 移除后台抓取线程 (`background_fetch_loop`)。
- **禁止** 修改现有计算公式，除非明确要求调整手续费。
- **禁止** 将敏感 API Key 硬编码在代码中。
- **禁止** 在前端引入庞大的构建工具链。

## 6. 任务执行流程
1. **理解**: 使用 `read` 工具读取 `app.py` 和 `index.html` 了解当前状态。
2. **规划**: 针对需求制定修改计划，特别注意线程安全和数据一致性。
3. **执行**: 修改代码，保持 4 空格缩进和既定风格。
4. **验证**: 运行 `python -m py_compile app.py` 确保无语法错误。

---
*Generated by OpenCode for reliable agentic collaboration.*
