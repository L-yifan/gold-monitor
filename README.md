# 个人投资监控系统 (Gold & Fund Monitor)

一个基于 Web 的轻量级个人投资看板，集成了**上海黄金交易所 (SGE) 实时金价监控**与**公募基金实时估值/持仓管理**功能。

![Python](https://img.shields.io/badge/python-3.8%2B-blue)
![Flask](https://img.shields.io/badge/flask-2.x-lightgrey)
![Vue](https://img.shields.io/badge/vue-3.x-green)
![TailwindCSS](https://img.shields.io/badge/tailwindcss-3.x-blue)
![License](https://img.shields.io/badge/license-MIT-blue.svg)

## 快速开始

### 1. 环境准备
需要 Python 3.8 或更高版本。

**自动环境检测**：
项目启动时会按以下优先级自动检测 Python 环境：
1. `launcher.ini` 中配置的 `python_path`
2. 本地 `venv/Scripts/python.exe` 虚拟环境
3. 本地 `.venv/Scripts/python.exe` 虚拟环境
4. 系统 `python` 命令

### 2. 安装依赖
```bash
pip install -r requirements.txt
```

**依赖说明**：
- `flask>=2.0.0` - Web 框架
- `requests>=2.25.0` - HTTP 请求库
- `beautifulsoup4>=4.14.0` - HTML 解析
- `lunardate>=0.2.0` - 农历日期计算

### 3. 运行

**方式一：Windows 批处理启动（推荐）**
```bash
双击 start.bat
```
- 自动检测 Python 环境
- 启动后自动打开浏览器访问 http://localhost:5000

**方式二：命令行启动**
```bash
python app.py
```
- 默认监听：`0.0.0.0:5000`
- 调试模式：`debug=True`

启动后访问: http://localhost:5000

## 版本历史

### v1.7.0 (2026-02-19)
**主题切换与代码重构**

- 新增深色/浅色主题切换功能
- CSS/JS 代码解耦，提高可维护性

### v1.6.1 (2026-02-17)
**UI 优化**

- 修改金价页主题颜色
- 新增数字滚动与卡片入场动画
- 优化基金页动画效果

### v1.6.0 (2026-02-16)
**智能节假日管理**

- 新增交易所日历，自动获取上交所休市安排
- 优化交易状态显示逻辑

### v1.5.0 (2026-02-16)
**基金列表视图与数据口径统一**

**新增功能**
- 新增**自选基金列表视图**，支持卡片/列表双模式切换
- 新增**表头排序**，点击列标题可按名称/涨跌幅/净值排序
- 新增**行高切换**（紧凑/舒适），适应不同屏幕密度
- 新增**视图偏好持久化**，自动记住用户选择的展示模式、排序方式和行高

**数据优化**
- 金价历史数据清理策略优化：从"24小时滑动窗口"改为"当日自然日"
- 前端文案统一："24H"相关描述改为"当日"，避免凌晨时段数据误解

**Bug 修复**
- 修复持久化清理时 `manual_records` 引用分叉问题，改为原地切片赋值
- 为 `load_data()` 添加锁保护，确保加载与清理的原子性
- 修复排序控制与表头排序的优先级冲突，统一排序状态管理

### v1.4.0 (2026-02-04)
**视觉与交互增强版本**

**新增功能**
- 新增**预估今日收益**汇总显示，实时展示当日盈亏
- 新增**交易状态胶囊**指示器，替代原有竖直书签设计
- 新增**数字脉冲动画**，数据变化时触发视觉反馈
- 新增**价格呼吸动画**，根据交易状态动态展示
- 新增**背景装饰动画**，提升视觉体验

**UI 优化**
- 交易状态显示支持悬停展开详情（剩余时间、下一事件）
- 基金汇总面板增加悬停交互效果
- 导航按钮添加 shimmer 光效
- 卡片背景呼吸效果增强

**Bug 修复**
- 修复前端金价数据不自动刷新的轮询问题
- 分离金价和基金轮询定时器变量，避免相互干扰
- 删除 checkTradingEvents 重复定义，恢复基金交易状态检测
- 添加轮询间隔防重复机制，减少不必要的定时器重建
- 改进 mounted() 异步初始化顺序，确保交易状态获取完成后再启动轮询

### v1.3.0 (2026-02)
**数据稳健性增强版本**

### v1.2.0 (2026-02)
- UI 升级：交易状态指示器、移动端适配
- Solid Dark 深色设计系统
- 图表和字体优化
- 基金收益回补和持仓降级策略

### v1.1.0 (2026-02)
- 模块化重构：models/services/routes 三层架构
- 目录规范化：config/ 和 data/
- 自动迁移支持

### v1.0.0 (2026-02)
- 初始版本发布
- 实时金价监控（SGE Au99.99）
- 四大数据源自动熔断与切换
- 基金实时估值与持仓管理

## 📑 目录
- [快速开始](#快速开始)
- [核心功能](#核心功能)
- [数据源说明](#数据源说明)
- [项目架构](#项目架构)
- [技术栈](#技术栈)
- [版本历史](#版本历史)
- [配置说明](#配置说明)
- [数据文件结构](#数据文件结构)
- [使用指南](#使用指南)
- [界面展示](#界面展示)
- [开发指南](#开发指南)
- [免责声明](#免责声明)

## 核心功能

本系统分为 **黄金监控** 与 **基金估值** 两大核心模块，帮助您实时掌握核心资产动态。

### 🏆 黄金监控 (Gold Monitor)
专注于 SGE Au99.99 现货黄金价格：
*   **实时行情**: 秒级更新 Au99.99 价格，支持开盘/昨收/最高/最低数据展示。
*   **多源熔断**: 自动轮询东方财富、腾讯、新浪、网易四大数据源，遇故障自动切换，确保数据不间断。
*   **收益计算**: 输入买入成本与克数，实时计算扣除手续费（0.5%）后的实际盈亏及收益率。
*   **图表**: 性能优化的 Chart.js 走势图，支持断档检测、24小时波动统计。
*   **智能预警**: 支持自定义高低价预警，触发时通过浏览器通知提醒。
*   **交易状态指示器**: 实时显示当前交易阶段、剩余时间、下一个事件。
*   **价格呼吸动画**: 根据涨跌状态动态展示呼吸光效，增强视觉反馈。


### 📊 基金估值 (Fund Valuation)
专注于场外基金的实时净值估算与持仓管理：
*   **实时估值**: 基于基金定期报告的前十大重仓股，结合 A 股/港股实时行情计算盘中拟合估值。
*   **持仓管理**: Web 端直接添加/编辑/删除基金持仓（代码/成本/份额），无需手动修改配置文件。
*   **资产分析**: 实时汇总总持仓市值、**预估今日收益**、累计盈亏及总收益率。
*   **自选列表**: 支持无持仓基金的关注与估值追踪，支持卡片/列表双视图展示。
*   **数字脉冲动画**: 收益数据变化时触发视觉脉冲反馈。
*   **交互效果**: 卡片悬停光效、呼吸动画增强沉浸感。

## 数据源说明（核心技术）

本项目的核心竞争力在于**多数据源熔断与自动切换机制**，确保在高并发和网络不稳定环境下的数据可靠性。

### 四大数据源（按优先级排序）

| 优先级 | 数据源 | 特点 |
|--------|--------|------|
| 1️⃣ | 东方财富 | 数据全，响应快 |
| 2️⃣ | 腾讯财经 | 备用主源 |
| 3️⃣ | 网易财经 | 稳定可靠 |
| 4️⃣ | 新浪财经 | 兜底方案 |

### 核心技术：熔断机制

**熔断参数**：
- **失败阈值**：连续失败 3 次
- **冷却时间**：60 秒
- **自动恢复**：冷却期后自动重试

**熔断逻辑**：
```
数据源请求
    ↓
是否成功？
    ↓ 是 → 返回数据
    ↓ 否
    失败计数 +1
    ↓
失败次数 ≥ 3次？
    ↓ 是 → 触发熔断，进入 60 秒冷却期
    ↓ 否 → 尝试下一个数据源
```

### ⚡ 性能优化

1. **并发采集**：使用 `ThreadPoolExecutor` (max_workers=10) 并发获取基金数据
2. **智能缓存**：
   - 基金数据缓存：60 秒 TTL
   - 持仓汇总缓存：10 秒 TTL
   - 过期容忍：300 秒（快速模式）
3. **后台轮询**：守护线程每 5 秒采集一次金价，确保数据连续性
4. **原子化持久化**：使用临时文件 + `fsync` 确保 JSON 数据完整性

### 🔄 自动切换示例

```
东方财富（失败 #1）→ 重试东方财富（失败 #2）→ 重试东方财富（失败 #3）
    ↓
    触发熔断，冷却 60 秒
    ↓
自动切换至 腾讯财经（成功）
    ↓
返回数据
```

## 项目架构

本项目采用**模块化架构设计**，核心逻辑分布在 `app/` 目录下的各个子模块中，通过 Flask Blueprint 进行路由管理。

### 架构图

```
┌─────────────────────────────────────────────────────────┐
│                     前端 (Vue 3 + Tailwind)             │
│  ─────────────────────────────────────────────────────── │
│  • 实时价格展示  • 图表可视化  • 持仓管理  • 预警配置   │
└──────────────────────────┬──────────────────────────────┘
                           │ HTTP/JSON
                           ↓
┌─────────────────────────────────────────────────────────┐
│              Flask 应用层 (app/routes/)                 │
│  ─────────────────────────────────────────────────────── │
│  /api/price    /api/funds    /api/holdings              │
└──────────────────────────┬──────────────────────────────┘
                           │
                           ↓
┌─────────────────────────────────────────────────────────┐
│            业务逻辑与服务层 (app/services/)             │
│  ─────────────────────────────────────────────────────── │
│  ① 数据源管理    ② 熔断控制    ③ 并发采集              │
│  ④ 缓存处理      ⑤ 数据清理    ⑥ 持久化                │
└──────────────────────────┬──────────────────────────────┘
                           │
                           ↓
┌─────────────────────────────────────────────────────────┐
│              数据与配置层 (config/ & data/)             │
│  ─────────────────────────────────────────────────────── │
│  data/data.json (持久化数据)   config/launcher.ini      │
└─────────────────────────────────────────────────────────┘
```

### 模块职责

- **app/models/**: 定义全局状态、共享变量及线程安全逻辑
- **app/services/**: 核心业务逻辑（抓取、计算、持久化、后台任务）
- **app/routes/**: Flask 路由定义，按功能拆分为 Blueprint
- **app/config.py**: 全局常量与环境配置
- **app.py**: 应用极简启动入口

- **主线程**：处理 HTTP 请求
- **后台线程**（daemon=True）：金价采集（5 秒轮询）
- **线程池**（ThreadPoolExecutor）：基金数据并发获取（max_workers=10）
- **线程安全**：全局 `RLock` 保护所有共享数据

## 技术栈

*   **后端**: Python Flask, Requests, Threading (并发采集)
*   **前端**: Vue 3 (Options API), Tailwind CSS
*   **设计语言**: Premium Solid Dark
*   **图表**: Chart.js
*   **数据存储**: 本地 JSON 文件 (轻量级/易迁移)

## 配置说明

### launcher.ini 配置

用于指定自定义 Python 解释器路径（文件位于 `config/launcher.ini`）：

```ini
[Settings]
python_path=D:\anaconda3\envs\my_env\python.exe
```

**说明**：
- 留空则使用自动检测（默认）
- 推荐使用虚拟环境以隔离依赖

### 虚拟环境创建

```bash
# Windows
python -m venv venv
venv\Scripts\activate
pip install -r requirements.txt

# macOS/Linux
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```

### 端口配置

当前硬编码为 `5000`，如需修改请编辑 `app.py` 最后一行：

```python
app.run(host='0.0.0.0', port=5000, debug=True, threaded=True, use_reloader=False)
```

## 数据文件结构

### data/data.json 字段说明

```json
{
  "manual_records": [],          // 手动价格记录（保留 7 天）
  "price_history": [],           // 历史价格数据（保留当日自然日）
  "alert_settings": {            // 价格预警配置
    "high": 0,
    "low": 0,
    "enabled": false
  },
  "fund_watchlist": [],          // 自选基金代码列表
  "fund_holdings": [             // 基金持仓数据
    {
      "code": "000001",
      "name": "基金名称",
      "cost_price": 1.0,
      "shares": 1000,
      "note": "备注"
    }
  ],
  "fund_portfolios": {}          // 基金重仓股缓存（保留当日自然日）
}
```

### API 响应字段说明

**持仓汇总响应 (holdingsSummary)**:
```json
{
  "total_cost": 10000.00,         // 持仓成本
  "total_value": 12000.00,        // 当前市值
  "total_today_profit": 500.00,   // 预估今日收益
  "total_profit": 2000.00,        // 累计盈亏
  "total_profit_rate": 20.00,     // 总收益率 (%)
  "count": 5                      // 持仓基金数量
}
```

### 数据清理策略

| 数据类型 | 保留期限 | 清理触发 |
|----------|----------|----------|
| 价格历史 | 当日自然日 | 每次 `save_data()` |
| 手动记录 | 7 天 | 每次 `save_data()` |
| 重仓股缓存 | 当日自然日 | 自动过期后重新获取 |

## 使用指南

### 黄金视角
1.  **设置成本**: 在左侧面板输入买入均价和持有克数。
2.  **数据导出**: 支持导出"手动记录点"或"当日全量历史"为 Excel/CSV 格式。

### 基金视角
1.  **添加持仓**: 点击"我的持仓"右上角的 `+` 按钮，输入 6 位基金代码。
2.  **查看详情**: 点击基金卡片，查看其重仓股对今日净值的贡献度拆解。

## 界面展示

### 金价监控主界面
<截图位置：金价监控主界面>
*实时价格、24H 波动统计、目标盈利计算、价格预警设置*

### 基金估值管理界面
<截图位置：基金估值管理界面>
*持仓总览、盈亏分析、重仓股贡献度、基金卡片*

## 开发指南

### 详细规范
开发者请阅读 **[AGENTS.md](AGENTS.md)** 获取完整的开发规范。

### 🔒 核心开发原则

1. **线程安全**
   - 所有全局变量访问必须使用 `with lock:` 保护
   - 使用 `threading.RLock()` 支持嵌套调用
   - 守护线程使用 `daemon=True`

2. **并发控制**
   - 使用 `ThreadPoolExecutor` (max_workers=10) 并发获取数据
   - 避免在全局作用域进行耗时操作

3. **错误处理**
   - 所有外部调用必须 `try-except` 保护
   - 数据获取失败返回 `None`，打印错误但不抛出异常
   - API 错误返回 JSON 格式：`{"success": False, "message": "错误描述"}`

4. **编码规范**
   - 所有 Python 文件添加 `# -*- coding: utf-8 -*-`
   - 使用中文注释和文档字符串
   - 导入顺序：标准库 → 第三方库 → 项目模块

5. **数据持久化**
   - 使用原子写入模式（临时文件 + fsync）
   - 始终使用 UTF-8 编码，`ensure_ascii=False`

### 🚀 快速添加数据源

```python
def fetch_from_new_source(source_config):
    """
    从新数据源获取 Au99.99 价格
    """
    try:
        url = "http://example.com/api"
        response = requests.get(url, headers=HEADERS, timeout=3)
        # 解析并返回标准格式数据
        return {
            "price": round(current_price, 2),
            "open": round(open_price, 2),
            "high": round(high_price, 2),
            "low": round(low_price, 2),
            "yesterday_close": round(yesterday_close, 2),
            "change": round(change, 2),
            "change_percent": round(change_percent, 2),
            "timestamp": datetime.now().timestamp(),
            "time_str": datetime.now().strftime("%H:%M:%S"),
            "source": source_config['name']
        }
    except Exception as e:
        print(f"[{source_config['name']}] 获取失败: {e}")
    return None
```

## 免责声明

本项目仅供编程学习与个人数据参考，**不构成任何投资建议**。市场有风险，投资需谨慎。

---

**🔥 技术亮点**：
- **多数据源自动熔断与切换** - 确保数据高可用性
- **线程安全的并发采集** - RLock 保护全局状态
- **高性能并发请求处理** - ThreadPoolExecutor + 智能缓存
- **原子化数据持久化** - 临时文件 + fsync 确保数据完整性
- **秒级实时更新** - 后台守护线程 5 秒轮询
- **视觉反馈系统** - 脉冲动画、呼吸效果增强交互体验
