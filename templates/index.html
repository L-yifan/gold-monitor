<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›½å†…é‡‘ä»·å®æ—¶ç›‘æ§ç³»ç»Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        @keyframes pulse-up-color {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } /* Red for Up */
            50% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
        }
        @keyframes pulse-down-color {
            0%, 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); } /* Green for Down */
            50% { box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); }
        }
        .pulse-up { animation: pulse-up-color 2s infinite; }
        .pulse-down { animation: pulse-down-color 2s infinite; }
        .price-up { color: #ef4444; } /* Red */
        .price-down { color: #22c55e; } /* Green */
        
        /* Red Gradient for Up/Rise */
        .bg-up { background: linear-gradient(135deg, #7f1d1d 0%, #991b1b 100%); }
        /* Green Gradient for Down/Fall */
        .bg-down { background: linear-gradient(135deg, #065f46 0%, #047857 100%); }
        
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        /* æ–°å¢ï¼šä»·æ ¼æ›´æ–°æ—¶çš„å¼¹è·³é«˜äº®æ•ˆæœ */
        @keyframes pop-in {
            0% { transform: scale(1); filter: brightness(1); }
            50% { transform: scale(1.05); filter: brightness(1.3); }
            100% { transform: scale(1); filter: brightness(1); }
        }
        .pop-effect {
            animation: pop-in 0.4s ease-out;
        }
        /* Vue è¿‡æ¸¡åŠ¨ç”» */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.5s; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        
        /* Modal Animation */
        .modal-enter-active, .modal-leave-active { transition: all 0.3s ease; }
        .modal-enter-from, .modal-leave-to { opacity: 0; transform: scale(0.95); }
        .modal-enter-to, .modal-leave-from { opacity: 1; transform: scale(1); }
        
        [v-cloak] { display: none; }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    
    {% raw %}
    <div id="app" v-cloak>
        <!-- é¡¶éƒ¨æ ‡é¢˜æ  -->
        <header class="fixed top-0 left-0 right-0 z-50 bg-gray-800/95 backdrop-blur-md border-b border-gray-700 py-4 px-6 shadow-md">
            <div class="max-w-7xl mx-auto flex justify-between items-center">
                <div class="flex-1">
                    <h1 class="text-2xl font-bold text-yellow-400 hidden sm:block">Au99.99 å®æ—¶ç›‘æ§</h1>
                    <h1 class="text-lg font-bold text-yellow-400 sm:hidden">Au99.99</h1>
                    <p class="text-gray-400 text-xs flex items-center gap-2">
                        <span>{{ currentData.source || 'SGE' }}</span>
                    </p>
                </div>

                <!-- å®æ—¶ä»·æ ¼æ˜¾ç¤º (ä¸‹æ»‘æ—¶ä¾ç„¶å¯è§) -->
                <div class="flex-1 flex justify-center items-center">
                    <div class="bg-gray-900/50 px-4 py-1 rounded-full border border-gray-700 flex items-center gap-3"
                         :class="{'pop-effect': priceAnimating}">
                        <span class="text-2xl font-bold font-mono transition-colors duration-300"
                              :class="isPriceUp ? 'text-red-500' : 'text-green-500'">
                            {{ formatPrice(currentData.price) }}
                        </span>
                        <span class="text-sm font-mono px-2 py-0.5 rounded bg-gray-800"
                              :class="isPriceUp ? 'text-red-400' : 'text-green-400'">
                            {{ currentData.change >= 0 ? '+' : '' }}{{ currentData.change }}
                        </span>
                    </div>
                </div>

                <div class="flex-1 text-right">
                    <p class="text-gray-400 text-xs hidden sm:block">æ›´æ–°æ—¶é—´</p>
                    <p class="text-sm sm:text-lg font-mono">{{ currentData.time_str || '--:--:--' }}</p>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto p-6 pt-28">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                <!-- å·¦ä¾§ï¼šå®æ—¶ä»·æ ¼é¢æ¿ -->
                <div class="lg:col-span-1 space-y-6">
                    
                    <!-- ç²˜æ€§ä»·æ ¼å®¹å™¨ (ä»…åœ¨æ¡Œé¢ç«¯æœ‰æ•ˆï¼Œå› ä¸ºç§»åŠ¨ç«¯å·²ç”± Header è¦†ç›–) -->
                    <div class="lg:sticky lg:top-28 space-y-6">
                        <!-- å½“å‰ä»·æ ¼å¡ç‰‡ -->
                        <div class="rounded-2xl p-6 transition-all duration-500"
                            :class="[isPriceUp ? 'bg-up pulse-up' : 'bg-down pulse-down', {'pop-effect': priceAnimating}]">
                        <p class="text-gray-200 mb-2 opacity-80">å½“å‰é‡‘ä»· (å…ƒ/å…‹)</p>
                        <div class="flex items-baseline gap-3">
                            <span class="text-5xl font-bold font-mono transition-transform duration-300" 
                                  :class="{'scale-110': priceAnimating}">
                                {{ formatPrice(currentData.price) }}
                            </span>
                            <span class="text-xl font-mono" :class="isPriceUp ? 'text-red-200' : 'text-green-200'">
                                {{ currentData.change >= 0 ? '+' : '' }}{{ currentData.change }}
                            </span>
                            <!-- Source Badge -->
                            <span v-if="currentData.source" 
                                  class="text-xs px-2 py-0.5 rounded border border-white/20 ml-auto self-start mt-2 opacity-70"
                                  :title="'æ•°æ®æ¥æº: ' + currentData.source">
                                {{ currentData.source }}
                            </span>
                        </div>
                        <div class="mt-4 grid grid-cols-2 gap-4 text-sm text-gray-200 opacity-90">
                            <div>
                                <p class="text-xs opacity-60">ä»Šå¼€</p>
                                <p class="font-mono">{{ formatPrice(currentData.open) }}</p>
                            </div>
                            <div>
                                <p class="text-xs opacity-60">æ˜¨æ”¶</p>
                                <p class="font-mono">{{ formatPrice(currentData.yesterday_close) }}</p>
                            </div>
                            <div>
                                <p class="text-xs opacity-60">æœ€é«˜</p>
                                <p class="font-mono text-red-300">{{ formatPrice(currentData.high) }}</p>
                            </div>
                            <div>
                                <p class="text-xs opacity-60">æœ€ä½</p>
                                <p class="font-mono text-green-300">{{ formatPrice(currentData.low) }}</p>
                            </div>
                        </div>

                        <!-- æ–°å¢ï¼š24å°æ—¶æ³¢åŠ¨æ‘˜è¦ -->
                        <div v-if="currentData.volatility" class="mt-4 pt-4 border-t border-white/10 grid grid-cols-2 gap-4 text-sm text-gray-200 opacity-90">
                            <div class="col-span-2 flex justify-between items-center mb-1">
                                <span class="text-xs font-bold text-yellow-400/80">24H æ³¢åŠ¨æ‘˜è¦</span>
                                <span class="text-[10px] opacity-40">åŸºäº {{ currentData.count }} æ ·æœ¬</span>
                            </div>
                            <div>
                                <p class="text-xs opacity-60">24H æœ€é«˜</p>
                                <p class="font-mono">{{ formatPrice(currentData.high_24h) }}</p>
                            </div>
                            <div>
                                <p class="text-xs opacity-60">24H æœ€ä½</p>
                                <p class="font-mono">{{ formatPrice(currentData.low_24h) }}</p>
                            </div>
                            <div>
                                <p class="text-xs opacity-60">24H æŒ¯å¹…</p>
                                <p class="font-mono text-yellow-300">{{ currentData.volatility }}</p>
                            </div>
                            <div>
                                <p class="text-xs opacity-60">24H å‡ä»·</p>
                                <p class="font-mono">{{ formatPrice(currentData.avg_24h) }}</p>
                            </div>
                        </div>
                    </div>

                    <!-- ä¹°å…¥ä»·æ ¼è®¾ç½® -->
                    <div class="bg-gray-800 rounded-2xl p-6 shadow-lg">
                        <h3 class="text-lg font-semibold mb-4 text-yellow-400">æˆ‘çš„ä¹°å…¥æˆæœ¬</h3>
                        <div class="flex gap-2">
                            <input type="number" v-model.number="buyPrice"
                                @focus="handleInputFocus($event)" 
                                @blur="handleInputBlur"
                                class="flex-1 bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-xl font-mono focus:outline-none focus:border-yellow-500 transition-colors"
                                placeholder="è¾“å…¥ä¹°å…¥ä»·æ ¼" step="0.01">
                            <button @click="resetToCurrent" 
                                class="bg-gray-700 hover:bg-gray-600 text-gray-300 px-4 py-3 rounded-lg transition"
                                title="é‡ç½®ä¸ºå½“å‰ä»·æ ¼">
                                â†º
                            </button>
                        </div>
                        <p class="text-gray-500 text-sm mt-2 flex justify-between">
                            <span>* æ‰‹ç»­è´¹ç‡: 0.5%</span>
                            <span v-if="buyPrice > 0" class="text-yellow-500/80">å·²è®¾æˆæœ¬: {{ buyPrice.toFixed(2) }}</span>
                            <span v-else class="text-gray-600">æœªè®¾ç½®</span>
                        </p>
                    </div>

                    <!-- å½“å‰ç›ˆäºçŠ¶æ€ -->
                    <div class="bg-gray-800 rounded-2xl p-6 shadow-lg border border-gray-700 transition-opacity duration-300"
                         :class="{'opacity-40 grayscale': !(buyPrice > 0)}">
                        <h3 class="text-lg font-semibold mb-4">å½“å‰ç›ˆäºçŠ¶æ€</h3>
                        <div class="text-center py-4">
                            <p class="text-gray-400 text-sm">è‹¥ç°åœ¨å–å‡º (æ‰£é™¤æ‰‹ç»­è´¹å)</p>
                            <p class="text-4xl font-bold font-mono my-2" 
                               :class="currentProfit.rate >= 0 ? 'text-red-500' : 'text-green-500'">
                               {{ buyPrice > 0 ? (currentProfit.rate >= 0 ? '+' : '') + currentProfit.rate + '%' : '--%' }}
                            </p>
                            <p class="text-gray-500 text-sm font-mono">
                                æ¯å…‹ç›ˆäº: {{ buyPrice > 0 ? (currentProfit.amount >= 0 ? '+' : '') + currentProfit.amount + ' å…ƒ' : '-- å…ƒ' }}
                            </p>
                        </div>
                        <!-- ç›ˆåˆ©è¿›åº¦æ¡ -->
                        <div class="mt-4 relative pt-6">
                            <div class="flex justify-between text-xs text-gray-500 mb-1 absolute top-0 w-full">
                                <span style="left: 0%">-10%</span>
                                <span style="left: 33.3%">0%</span>
                                <span style="right: 0">+20%</span>
                            </div>
                            <div class="h-3 bg-gray-700 rounded-full overflow-hidden relative">
                                <!-- 0ç‚¹å‚è€ƒçº¿ -->
                                <div class="absolute h-full w-0.5 bg-gray-600 left-1/3 z-10"></div>
                                <div class="h-full transition-all duration-500 relative"
                                     :style="buyPrice > 0 ? profitBarStyle : {width: '0%', left: '33.3%'}"
                                     :class="currentProfit.rate >= 0 ? 'bg-red-500' : 'bg-green-500'">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- è®°å½•æŒ‰é’® -->
                    <button @click="recordPrice" 
                        :disabled="!(buyPrice > 0)"
                        class="w-full font-bold py-4 rounded-xl transition shadow-lg flex justify-center items-center gap-2"
                        :class="buyPrice > 0 ? 'bg-blue-600 hover:bg-blue-700 text-white hover:shadow-blue-900/50' : 'bg-gray-700 text-gray-500 cursor-not-allowed'">
                        <span>è®°å½•å½“å‰ä»·æ ¼</span>
                        <span v-if="isRecording" class="animate-spin">â³</span>
                    </button>
                </div>
            </div>

            <!-- å³ä¾§ï¼šå›¾è¡¨å’Œç›®æ ‡ -->
            <div class="lg:col-span-2 space-y-6">
                    
                    <!-- ä»·æ ¼èµ°åŠ¿å›¾ -->
                    <div class="bg-gray-800 rounded-2xl p-6 shadow-lg border border-gray-700">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">å®æ—¶ä»·æ ¼èµ°åŠ¿</h3>
                            <span class="text-gray-500 text-sm flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-yellow-400 animate-pulse"></span>
                                æ¯5ç§’æ›´æ–°
                            </span>
                        </div>
                        <div class="h-64">
                            <canvas id="priceChart" ref="priceChart"></canvas>
                        </div>
                    </div>

                    <!-- ä»·æ ¼é¢„è­¦è®¾ç½® -->
                    <div class="bg-gray-800 rounded-2xl p-6 shadow-lg border border-gray-700">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-yellow-400">ä»·æ ¼é¢„è­¦ (æµè§ˆå™¨é€šçŸ¥)</h3>
                            <div class="flex items-center gap-3">
                                <button @click="resetAlertsToDefault" class="text-[10px] text-gray-500 hover:text-yellow-500 border border-gray-700 px-2 py-1 rounded transition">
                                    é‡ç½®ä¸º Â±3%
                                </button>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" v-model="settings.enabled" @change="saveSettings" class="sr-only peer">
                                    <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-yellow-500"></div>
                                </label>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-xs text-gray-500 block mb-1">é‡‘ä»·é«˜äº (å…ƒ/å…‹)</label>
                                <input type="number" v-model.number="settings.high" @blur="saveSettings"
                                    class="w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-yellow-500"
                                    placeholder="0.00" step="0.01">
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 block mb-1">é‡‘ä»·ä½äº (å…ƒ/å…‹)</label>
                                <input type="number" v-model.number="settings.low" @blur="saveSettings"
                                    class="w-full bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-yellow-500"
                                    placeholder="0.00" step="0.01">
                            </div>
                        </div>
                        <p class="text-[10px] text-gray-500 mt-3 italic">* å¼€å¯åè¯·ç¡®ä¿å…è®¸æµè§ˆå™¨é€šçŸ¥ã€‚è§¦å‘åå°†è¿›å…¥ 5 åˆ†é’Ÿå†·å´æœŸã€‚</p>
                    </div>

                    <!-- å¤šç›®æ ‡ç›ˆåˆ©è®¡ç®—è¡¨ -->
                    <div class="bg-gray-800 rounded-2xl p-6 shadow-lg border border-gray-700 transition-opacity duration-300"
                         :class="{'opacity-40 grayscale': !(buyPrice > 0)}">
                        <h3 class="text-lg font-semibold mb-4 text-yellow-400">ç›®æ ‡å–å‡ºä»·æ ¼</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead>
                                    <tr class="text-gray-400 text-sm border-b border-gray-700">
                                        <th class="text-left py-3">ç›®æ ‡ç›ˆåˆ©</th>
                                        <th class="text-right py-3">æ¯å…‹ç›ˆåˆ©</th>
                                        <th class="text-right py-3">éœ€æ¶¨è‡³</th>
                                        <th class="text-right py-3">å®é™…æ¶¨å¹…</th>
                                        <th class="text-right py-3">è·ç›®æ ‡</th>
                                        <th class="text-right py-3">çŠ¶æ€</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template v-if="buyPrice > 0">
                                        <tr v-for="target in targetTable" :key="target.percent" 
                                            class="border-b border-gray-700/50 hover:bg-gray-700/30 transition-colors"
                                            :class="{'bg-red-900/20': target.reached}">
                                            <td class="py-4">
                                                <span class="font-bold" :class="target.reached ? 'text-red-400' : 'text-yellow-400'">
                                                    +{{ target.percent }}%
                                                </span>
                                            </td>
                                            <td class="text-right py-4 font-mono text-blue-400">
                                                {{ target.profitAmount }} å…ƒ
                                            </td>
                                            <td class="text-right py-4 font-mono text-lg">{{ target.sellPrice }}</td>
                                            <td class="text-right py-4 text-gray-400 font-mono">+{{ target.requiredGain }}%</td>
                                            <td class="text-right py-4 font-mono">
                                                <span v-if="target.reached" class="text-red-400 font-bold">å·²è¾¾æˆ</span>
                                                <span v-else class="text-gray-400">{{ target.progress }}%</span>
                                            </td>
                                            <td class="text-right py-4">
                                                <span v-if="target.reached" class="px-2 py-1 bg-red-600/20 text-red-400 rounded text-xs border border-red-600/50">
                                                    å¯å–å‡º
                                                </span>
                                                <span v-else class="px-2 py-1 bg-gray-700 text-gray-400 rounded text-xs">
                                                    ç­‰å¾…ä¸­
                                                </span>
                                            </td>
                                        </tr>
                                    </template>
                                    <tr v-else>
                                        <td colspan="5" class="py-12 text-center text-gray-500 italic">
                                            è¯·è¾“å…¥ä¹°å…¥æˆæœ¬ä»¥è®¡ç®—ç›®æ ‡
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- å†å²è®°å½• -->
                    <div class="bg-gray-800 rounded-2xl p-6 shadow-lg border border-gray-700">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">ä»·æ ¼è®°å½•</h3>
                            <div class="flex gap-2">
                                <button @click="exportCSV" class="text-blue-400 hover:text-blue-300 text-sm px-3 py-1 hover:bg-blue-900/20 rounded transition">
                                    å¯¼å‡ºè®°å½•
                                </button>
                                <button @click="exportHistoryCSV" class="text-yellow-400 hover:text-yellow-300 text-sm px-3 py-1 hover:bg-yellow-900/20 rounded transition">
                                    å¯¼å‡º 24H å†å²
                                </button>
                                <button @click="clearRecords" class="text-red-400 hover:text-red-300 text-sm px-3 py-1 hover:bg-red-900/20 rounded transition">
                                    æ¸…ç©ºè®°å½•
                                </button>
                            </div>
                        </div>
                        <div class="space-y-2 max-h-64 overflow-y-auto pr-2 custom-scrollbar">
                            <div v-if="records.length === 0" class="text-gray-500 text-center py-8 bg-gray-700/20 rounded-lg">
                                æš‚æ— è®°å½•
                            </div>
                            <transition-group name="fade">
                                <div v-for="(record, index) in reversedRecords" :key="index" 
                                    class="flex justify-between items-center bg-gray-700/30 hover:bg-gray-700/50 rounded-lg p-3 border border-gray-700/50 transition-colors">
                                    <div>
                                        <span class="font-mono text-lg text-yellow-100">{{ formatPrice(record.price) }}</span>
                                        <span class="text-gray-500 text-sm ml-2 font-mono">{{ record.time_str }}</span>
                                    </div>
                                    <div class="text-right">
                                        <span class="font-mono font-bold" 
                                            :class="parseFloat(record.profit) >= 0 ? 'text-red-400' : 'text-green-400'">
                                            {{ parseFloat(record.profit) >= 0 ? '+' : '' }}{{ record.profit }}%
                                        </span>
                                    </div>
                                </div>
                            </transition-group>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- çŠ¶æ€æŒ‡ç¤ºå™¨ -->
        <div class="fixed bottom-4 right-4 flex items-center gap-2 bg-gray-800 px-4 py-2 rounded-full shadow-lg border border-gray-700 z-50">
            <span class="w-3 h-3 rounded-full transition-colors duration-300" 
                  :class="[isConnected ? 'bg-green-500 animate-pulse' : 'bg-red-500']"></span>
            <span class="text-sm font-medium">{{ isConnected ? 'å®æ—¶è¿æ¥ä¸­' : 'è¿æ¥ä¸­æ–­' }}</span>
        </div>

        <!-- è‡ªå®šä¹‰æ¨¡æ€æ¡† (Modal) -->
        <transition name="modal">
            <div v-if="modal.visible" class="fixed inset-0 z-[100] flex items-center justify-center px-4" @keydown.esc="closeModal(false)">
                <!-- é®ç½©å±‚ -->
                <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" @click="closeModal(false)"></div>
                
                <!-- å¼¹çª—ä¸»ä½“ -->
                <div class="relative bg-gray-800 rounded-2xl shadow-2xl border border-gray-700 w-full max-w-md p-6 transform transition-all">
                    <h3 class="text-xl font-bold mb-4 text-white">{{ modal.title }}</h3>
                    
                    <!-- Prompt æ¨¡å¼ä¸‹çš„è¾“å…¥æ¡† -->
                    <div v-if="modal.type === 'prompt'" class="mb-6">
                        <input ref="modalInput" 
                               v-model="modal.inputValue" 
                               @keyup.enter="closeModal(true)"
                               type="text" 
                               class="w-full bg-gray-900 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-yellow-500 transition-colors placeholder-gray-500"
                               :placeholder="modal.placeholder">
                    </div>

                    <!-- Confirm æ¨¡å¼ä¸‹çš„æç¤ºæ–‡æœ¬ -->
                    <div v-if="modal.type === 'confirm'" class="mb-6 text-gray-300">
                        {{ modal.message }}
                    </div>

                    <!-- æŒ‰é’®ç»„ -->
                    <div class="flex justify-end gap-3">
                        <button @click="closeModal(false)" 
                                class="px-5 py-2 rounded-lg bg-gray-700 text-gray-300 hover:bg-gray-600 transition-colors font-medium">
                            å–æ¶ˆ
                        </button>
                        <button @click="closeModal(true)" 
                                class="px-5 py-2 rounded-lg font-bold transition-colors shadow-lg"
                                :class="modal.confirmButtonClass || 'bg-blue-600 hover:bg-blue-500 text-white'">
                            {{ modal.confirmText || 'ç¡®å®š' }}
                        </button>
                    </div>
                </div>
            </div>
        </transition>

    </div>
    {% endraw %}

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    // æ•°æ®çŠ¶æ€
                    currentData: {
                        price: 0,
                        change: 0,
                        open: 0,
                        yesterday_close: 0,
                        high: 0,
                        low: 0,
                        time_str: '--:--:--'
                    },
                    buyPrice: 0,
                    records: [],
                    historyData: [], // ç”¨äºå›¾è¡¨
                    
                    // ç³»ç»ŸçŠ¶æ€
                    isConnected: false,
                    isRecording: false,
                    hasInitializedBuyPrice: false,
                    timer: null,
                    tempBuyPrice: null, // ç”¨äºè¾“å…¥æ¡†è·å–ç„¦ç‚¹æ—¶æš‚å­˜æ•°æ®
                    priceAnimating: false, // æ§åˆ¶ä»·æ ¼è·³åŠ¨åŠ¨ç”»
                    priceAnimTimer: null, // åŠ¨ç”»å®šæ—¶å™¨å¼•ç”¨
                    // é¢„è­¦è®¾ç½®
                    settings: {
                        high: 0,
                        low: 0,
                        enabled: false
                    },
                    lastNotifiedTime: 0, // ä¸Šæ¬¡é€šçŸ¥æ—¶é—´
                    // æ¨¡æ€æ¡†çŠ¶æ€
                    modal: {
                        visible: false,
                        type: 'prompt', // 'prompt' | 'confirm'
                        title: '',
                        message: '',
                        placeholder: '',
                        inputValue: '',
                        confirmText: 'ç¡®å®š',
                        confirmButtonClass: '',
                        resolve: null // Promise resolve function
                    }
                    // chartInstance å·²ç§»é™¤ï¼Œé¿å… Vue ä»£ç†å¯¼è‡´çš„å›¾è¡¨å¡æ­»é—®é¢˜
                }
            },
            created() {
                this.chartInstance = null; // éå“åº”å¼å˜é‡
            },
            computed: {
                isPriceUp() {
                    return this.currentData.change >= 0;
                },
                currentProfit() {
                    if (!this.buyPrice || this.buyPrice <= 0 || !this.currentData.price) {
                        return { rate: '0.00', amount: '0.00' };
                    }
                    const feeRate = 0.005;
                    const actualReceive = this.currentData.price * (1 - feeRate);
                    const rate = ((actualReceive - this.buyPrice) / this.buyPrice * 100);
                    const amount = actualReceive - this.buyPrice;
                    return {
                        rate: rate.toFixed(2),
                        amount: amount.toFixed(2)
                    };
                },
                profitBarStyle() {
                    const rate = parseFloat(this.currentProfit.rate);
                    // èŒƒå›´ -10% åˆ° +20% (æ€»è·¨åº¦ 30%)
                    // -10% å¯¹åº” left 0%
                    // 0% å¯¹åº” left 33.3%
                    // +20% å¯¹åº” left 100%
                    
                    if (rate <= -10) return { width: '0%', left: '0%' };
                    if (rate >= 20) return { width: '66.7%', left: '33.3%' };

                    if (rate < 0) {
                        // -10 åˆ° 0 ä¹‹é—´
                        const widthPct = ((rate + 10) / 10) * 33.3;
                        return { width: `${widthPct}%`, left: '0%' }; // ç®€åŒ–å¤„ç†ï¼Œå®é™…åº”è¯¥é å³å¯¹é½åˆ°å‚è€ƒçº¿
                    } else {
                        // 0 åˆ° 20 ä¹‹é—´
                        const widthPct = (rate / 20) * 66.7;
                        return { width: `${widthPct}%`, left: '33.3%' };
                    }
                },
                targetTable() {
                    if (!this.buyPrice || this.buyPrice <= 0) return [];
                    
                    const targets = [5, 10, 15, 20, 30];
                    const feeRate = 0.005;
                    
                    return targets.map(percent => {
                        // ç›®æ ‡å–å‡ºä»· = ä¹°å…¥ä»· * (1 + åˆ©æ¶¦ç‡) / (1 - æ‰‹ç»­è´¹)
                        const sellPrice = this.buyPrice * (1 + percent / 100) / (1 - feeRate);
                        const profitAmount = (this.buyPrice * percent / 100).toFixed(2);
                        const requiredGain = ((sellPrice - this.buyPrice) / this.buyPrice * 100);
                        const reached = this.currentData.price >= sellPrice;
                        // è®¡ç®—è¿›åº¦ 0-100%
                        const progress = Math.min(100, Math.max(0, 
                            (this.currentData.price - this.buyPrice) / (sellPrice - this.buyPrice) * 100
                        ));

                        return {
                            percent,
                            sellPrice: sellPrice.toFixed(2),
                            profitAmount: profitAmount,
                            requiredGain: requiredGain.toFixed(2),
                            reached,
                            progress: progress.toFixed(1)
                        };
                    });
                },
                reversedRecords() {
                    return [...this.records].reverse();
                }
            },
            methods: {
                handleResize() {
                    if (this.chartInstance) {
                        this.chartInstance.options.layout.padding.right = window.innerWidth < 640 ? 60 : 110;
                        this.chartInstance.update('none');
                    }
                },
                formatPrice(val) {
                    return val ? Number(val).toFixed(2) : '--';
                },
                processDataForChart(rawData) {
                    if (!rawData || rawData.length === 0) return [];
                    
                    const now = Date.now() / 1000;
                    const window30min = 30 * 60;
                    const bucketSize = 5 * 60; // 5åˆ†é’Ÿä¸€æ¡¶
                    const maxGap = 10 * 60; // 10åˆ†é’Ÿæ²¡æœ‰æ•°æ®è§†ä¸ºæ–­æ¡£
                    
                    let recentData = [];
                    let buckets = {};

                    // æŒ‰æ—¶é—´æ’åºç¡®ä¿é€»è¾‘æ­£ç¡®
                    const sortedData = [...rawData].sort((a, b) => a.timestamp - b.timestamp);

                    sortedData.forEach(item => {
                        const age = now - item.timestamp;
                        if (age <= window30min) {
                            recentData.push(item);
                        } else {
                            const bucketKey = Math.floor(item.timestamp / bucketSize);
                            if (!buckets[bucketKey]) {
                                buckets[bucketKey] = { min: item, max: item };
                            } else {
                                if (item.price < buckets[bucketKey].min.price) buckets[bucketKey].min = item;
                                if (item.price > buckets[bucketKey].max.price) buckets[bucketKey].max = item;
                            }
                        }
                    });

                    let bucketList = Object.values(buckets).flatMap(b => {
                        if (b.min.timestamp === b.max.timestamp) return [b.min];
                        return b.min.timestamp < b.max.timestamp ? [b.min, b.max] : [b.max, b.min];
                    });

                    // åˆå¹¶å¹¶æ’åº
                    let mergedData = [...bucketList, ...recentData].sort((a, b) => a.timestamp - b.timestamp);
                    
                    // æ’å…¥æ–­æ¡£æ ‡è®° (null) ä»¥å®ç°è¿çº¿æ–­å¼€
                    let finalData = [];
                    for (let i = 0; i < mergedData.length; i++) {
                        if (i > 0) {
                            const gap = mergedData[i].timestamp - mergedData[i-1].timestamp;
                            if (gap > maxGap) {
                                // æ’å…¥ä¸€ä¸ª null ç‚¹ï¼ŒChart.js ä¼šè‡ªåŠ¨æ–­å¼€çº¿
                                finalData.push({ x: (mergedData[i-1].timestamp + 1), y: null });
                            }
                        }
                        finalData.push({ x: mergedData[i].timestamp, y: mergedData[i].price });
                    }
                    
                    return finalData;
                },
                handleInputFocus(event) {
                    // ä¸å†æ¸…ç©º buyPriceï¼Œè€Œæ˜¯å…¨é€‰æ–‡å­—æ–¹ä¾¿ä¿®æ”¹
                    if (event && event.target) {
                        event.target.select();
                    }
                },
                handleInputBlur() {
                    // å¤±å»ç„¦ç‚¹æ—¶ï¼Œå¦‚æœä¸ºç©ºåˆ™ä¿æŒä¸ºç©ºï¼Œç­‰å¾…ç”¨æˆ·ä¸‹æ¬¡è¾“å…¥æˆ–ç‚¹å‡»é‡ç½®
                },
                resetToCurrent() {
                    if (this.currentData.price > 0) {
                        this.buyPrice = this.currentData.price;
                    }
                },
                async fetchPrice() {
                    try {
                        const res = await fetch('/api/price');
                        const data = await res.json();
                        
                        if (data.success) {
                            this.isConnected = true;
                            this.currentData = data.data;
                            
                            // æ£€æŸ¥é¢„è­¦
                            this.checkAlerts(data.data.price);

                            // é¦–æ¬¡åˆå§‹åŒ–ä¹°å…¥ä»·
                            if (!this.hasInitializedBuyPrice && data.data.price > 0) {
                                this.buyPrice = data.data.price;
                                
                                // è‡ªåŠ¨åˆå§‹åŒ–é¢„è­¦å€¼ä¸º +-3% (ä»…å½“å°šæœªè®¾ç½®è¿‡æ—¶)
                                if (this.settings.high === 0 && this.settings.low === 0) {
                                    this.settings.high = parseFloat((data.data.price * 1.03).toFixed(2));
                                    this.settings.low = parseFloat((data.data.price * 0.97).toFixed(2));
                                    this.saveSettings();
                                }
                                
                                this.hasInitializedBuyPrice = true;
                            }

                            // ä»…å½“ä»·æ ¼å‘ç”Ÿå˜åŒ–æˆ–é¦–æ¬¡åŠ è½½æ—¶æ‰è§¦å‘åŠ¨ç”»
                            const priceChanged = this.currentData.price !== data.data.price;
                            
                            this.currentData = data.data;

                            // æ›´æ–°å›¾è¡¨æ•°æ®
                            this.updateChartData(data.data);
                            
                            // è§¦å‘è·³åŠ¨åŠ¨ç”» (ä»…åœ¨ä»·æ ¼å˜åŠ¨ä¸”éé¦–æ¬¡åŠ è½½æ—¶ï¼Œæˆ–è€…æ˜¯é¦–æ¬¡åŠ è½½)
                            if (priceChanged) {
                                // æ¸…é™¤å¯èƒ½å­˜åœ¨çš„æ—§å®šæ—¶å™¨ï¼Œé˜²æ­¢å†²çª
                                if (this.priceAnimTimer) clearTimeout(this.priceAnimTimer);
                                
                                this.priceAnimating = true;
                                this.priceAnimTimer = setTimeout(() => {
                                    this.priceAnimating = false;
                                    this.priceAnimTimer = null;
                                }, 400); // å¯¹åº” CSS åŠ¨ç”»æ—¶é•¿
                            }

                        } else {
                            this.isConnected = false;
                        }
                    } catch (e) {
                        console.error(e);
                        this.isConnected = false;
                    }
                },
                async fetchHistory() {
                    try {
                        const res = await fetch('/api/history');
                        const data = await res.json();
                        if (data.success) {
                            this.historyData = data.data;
                            this.initChart();
                        }
                    } catch (e) { console.error(e); }
                },
                async fetchRecords() {
                    try {
                        const res = await fetch('/api/records');
                        const data = await res.json();
                        if (data.success) this.records = data.data;
                    } catch (e) { console.error(e); }
                },
                async fetchSettings() {
                    try {
                        const res = await fetch('/api/settings');
                        const data = await res.json();
                        if (data.success) this.settings = data.settings;
                    } catch (e) { console.error(e); }
                },
                resetAlertsToDefault() {
                    if (this.currentData.price > 0) {
                        this.settings.high = parseFloat((this.currentData.price * 1.03).toFixed(2));
                        this.settings.low = parseFloat((this.currentData.price * 0.97).toFixed(2));
                        this.saveSettings();
                    }
                },
                async saveSettings() {
                    if (this.settings.enabled && Notification.permission !== "granted") {
                        const permission = await Notification.requestPermission();
                        if (permission !== "granted") {
                            this.settings.enabled = false;
                            alert("éœ€è¦æµè§ˆå™¨é€šçŸ¥æƒé™æ‰èƒ½å¼€å¯é¢„è­¦ï¼Œå–µï¼");
                        }
                    }

                    try {
                        await fetch('/api/settings', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.settings)
                        });
                    } catch (e) { console.error(e); }
                },
                checkAlerts(currentPrice) {
                    if (!this.settings.enabled || currentPrice <= 0) return;

                    const now = Date.now();
                    const cooldown = 5 * 60 * 1000; // 5åˆ†é’Ÿå†·å´

                    if (now - this.lastNotifiedTime < cooldown) return;

                    let msg = "";
                    if (this.settings.high > 0 && currentPrice >= this.settings.high) {
                        msg = `ğŸ“ˆ é‡‘ä»·å·²æ¶¨è‡³ ${currentPrice}ï¼Œè¶…è¿‡é¢„è­¦çº¿ ${this.settings.high}`;
                    } else if (this.settings.low > 0 && currentPrice <= this.settings.low) {
                        msg = `ğŸ“‰ é‡‘ä»·å·²è·Œè‡³ ${currentPrice}ï¼Œä½äºé¢„è­¦çº¿ ${this.settings.low}`;
                    }

                    if (msg) {
                        this.sendNotification("é‡‘ä»·æé†’ (Au99.99)", msg);
                        this.lastNotifiedTime = now;
                    }
                },
                sendNotification(title, body) {
                    if (Notification.permission === "granted") {
                        new Notification(title, {
                            body: body,
                            icon: "https://p3.itc.cn/images01/20210712/f6d76a7f34034442a8656157834241e3.png" // é‡‘ç‰Œå›¾æ ‡å ä½
                        });
                    }
                },
                
                // é€šç”¨ Modal æ–¹æ³•: Prompt
                openPrompt(title, placeholder = '') {
                    return new Promise((resolve) => {
                        this.modal = {
                            visible: true,
                            type: 'prompt',
                            title: title,
                            placeholder: placeholder,
                            inputValue: '',
                            confirmText: 'ç¡®è®¤è®°å½•',
                            confirmButtonClass: 'bg-blue-600 hover:bg-blue-500 text-white shadow-blue-900/50',
                            resolve: resolve
                        };
                        this.$nextTick(() => {
                            if(this.$refs.modalInput) this.$refs.modalInput.focus();
                        });
                    });
                },

                // é€šç”¨ Modal æ–¹æ³•: Confirm
                openConfirm(title, message, confirmText = 'ç¡®å®š', confirmClass = 'bg-red-600 hover:bg-red-500 text-white shadow-red-900/50') {
                    return new Promise((resolve) => {
                        this.modal = {
                            visible: true,
                            type: 'confirm',
                            title: title,
                            message: message,
                            confirmText: confirmText,
                            confirmButtonClass: confirmClass,
                            resolve: resolve
                        };
                    });
                },

                closeModal(result) {
                    if (this.modal.resolve) {
                        if (this.modal.type === 'prompt') {
                            // Prompt è¿”å›è¾“å…¥å€¼æˆ– null
                            this.modal.resolve(result ? this.modal.inputValue : null);
                        } else {
                            // Confirm è¿”å› true/false
                            this.modal.resolve(result);
                        }
                    }
                    this.modal.visible = false;
                    this.modal.resolve = null;
                },

                async recordPrice() {
                    if (this.isRecording) return;
                    
                    this.isRecording = true;
                    
                    const payload = {
                        price: this.currentData.price,
                        buy_price: this.buyPrice,
                        profit: this.currentProfit.rate,
                        note: '' // å¤‡æ³¨åŠŸèƒ½å·²å–æ¶ˆ
                    };

                    try {
                        const res = await fetch('/api/record', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(payload)
                        });
                        const data = await res.json();
                        if (data.success) {
                            this.records.push(data.record);
                        }
                    } catch(e) { console.error(e); }
                    finally { this.isRecording = false; }
                },
                async clearRecords() {
                    // ä½¿ç”¨è‡ªå®šä¹‰ Modal æ›¿ä»£åŸç”Ÿ confirm
                    const confirmed = await this.openConfirm(
                        'ç¡®è®¤æ¸…ç©º', 
                        'ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚',
                        'æ¸…ç©ºè®°å½•'
                    );
                    
                        if(!confirmed) return;
                    
                    try {
                        await fetch('/api/records/clear', { method: 'POST' });
                        this.records = [];
                    } catch(e) { console.error(e); }
                },
                exportCSV() {
                    if (this.records.length === 0) return;
                    
                    let csvContent = "\ufeff"; // BOM
                    csvContent += "æ—¶é—´,ä»·æ ¼(å…ƒ/å…‹),ä¹°å…¥æˆæœ¬,ç›ˆäºç‡(%)\n";
                    
                    this.records.forEach(r => {
                        csvContent += `${r.time_str},${r.price},${r.buy_price},${r.profit}\n`;
                    });
                    
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement("a");
                    link.setAttribute("href", url);
                    link.setAttribute("download", `gold_price_records_${new Date().toISOString().split('T')[0]}.csv`);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                },
                exportHistoryCSV() {
                    if (this.historyData.length === 0) return;
                    
                    let csvContent = "\ufeff"; // BOM
                    csvContent += "æ—¶é—´,ä»·æ ¼(å…ƒ/å…‹)\n";
                    
                    // æŒ‰ç…§æ—¶é—´é™åºæ’åˆ—ï¼Œæ–¹ä¾¿æŸ¥çœ‹
                    const sortedHistory = [...this.historyData].sort((a, b) => b.timestamp - a.timestamp);
                    
                    sortedHistory.forEach(h => {
                        const timeStr = new Date(h.timestamp * 1000).toLocaleString();
                        csvContent += `${timeStr},${h.price}\n`;
                    });
                    
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement("a");
                    link.setAttribute("href", url);
                    link.setAttribute("download", `gold_24h_history_${new Date().toISOString().split('T')[0]}.csv`);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                },
                initChart() {

                    if (this.chartInstance) return;
                    
                    // ä½¿ç”¨ nextTick ç¡®ä¿ DOM å·²æ¸²æŸ“
                    this.$nextTick(() => {
                        const canvas = this.$refs.priceChart;
                        if (!canvas) return;
                        
                        const ctx = canvas.getContext('2d');
                        const chartData = this.processDataForChart(this.historyData);

                        this.chartInstance = new Chart(ctx, {
                            type: 'line',
                            data: {
                                datasets: [{
                                    label: 'Au99.99 ä»·æ ¼',
                                    data: chartData,
                                    borderColor: '#facc15',
                                    borderWidth: 2,
                                    fill: true,
                                    // æ¸å˜å¡«å……
                                    backgroundColor: (context) => {
                                        const chart = context.chart;
                                        const {ctx, chartArea} = chart;
                                        if (!chartArea) return null;
                                        const gradient = ctx.createLinearGradient(0, chartArea.top, 0, chartArea.bottom);
                                        gradient.addColorStop(0, 'rgba(250, 204, 21, 0.4)');
                                        gradient.addColorStop(1, 'rgba(250, 204, 21, 0)');
                                        return gradient;
                                    },
                                    tension: 0.4,
                                    spanGaps: false, // å¼ºåˆ¶æ–­æ¡£
                                    pointRadius: 0,
                                    pointHoverRadius: 4,
                                    pointBackgroundColor: '#facc15',
                                    pointBorderColor: '#fff',
                                    pointBorderWidth: 2
                                }]
                            },
                            options: {
                                 responsive: true,
                                maintainAspectRatio: false,
                                layout: {
                                    padding: {
                                        top: 30,    // å¢åŠ é¡¶éƒ¨è¾¹è·ï¼Œé˜²æ­¢æœ€é«˜ä»·æ ‡ç­¾è¢«åˆ‡æ–­
                                        bottom: 20, // å¢åŠ åº•éƒ¨è¾¹è·ï¼Œé˜²æ­¢æœ€ä½ä»·æ ‡ç­¾é‡å 
                                        left: 5,
                                        right: window.innerWidth < 640 ? 60 : 110  // ç§»åŠ¨ç«¯åŠ¨æ€å‡å°‘å³ä¾§è¾¹è·
                                    }
                                },

                                animation: {
                                    duration: 1000,
                                    easing: 'easeOutQuart'
                                },
                                plugins: { 
                                    legend: { display: false },
                                    tooltip: {
                                        backgroundColor: 'rgba(31, 41, 55, 0.9)',
                                        titleColor: '#facc15',
                                        bodyFont: { family: 'monospace' },
                                        padding: 10,
                                        cornerRadius: 8,
                                        displayColors: false,
                                        callbacks: {
                                            title: (items) => {
                                                const timestamp = items[0].parsed.x;
                                                return new Date(timestamp * 1000).toLocaleString();
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    x: { 
                                        type: 'linear', // åˆ‡æ¢ä¸ºçº¿æ€§æ—¶é—´è½´
                                        grid: { color: 'rgba(255,255,255,0.05)' }, 
                                        ticks: { 
                                            color: '#9ca3af', 
                                            maxTicksLimit: 8, 
                                            font: { size: 10 },
                                            callback: (value) => {
                                                const d = new Date(value * 1000);
                                                return `${d.getHours()}:${String(d.getMinutes()).padStart(2, '0')}`;
                                            }
                                        } 
                                    },
                                    y: { 
                                        grid: { color: 'rgba(255,255,255,0.05)' }, 
                                        ticks: { 
                                            color: '#9ca3af',
                                            callback: (value) => value.toFixed(1),
                                            font: { size: 10 }
                                        } 
                                    }
                                },
                                 interaction: { intersect: false, mode: 'index' }
                            },
                            plugins: [{
                                id: 'highLowMarkers',
                                afterDatasetsDraw(chart) {
                                     const { ctx, scales: { y }, chartArea: { left, right } } = chart;
                                    const isMobile = window.innerWidth < 640;
                                    const dataset = chart.data.datasets[0].data;

                                    const validData = dataset.filter(d => d.y !== null).map(d => d.y);
                                    if (validData.length < 2) return;
 
                                    let minPrice = Math.min(...validData);
                                    let maxPrice = Math.max(...validData);

                                    
                                     const drawLabel = (val, color, label) => {
                                        const yPos = y.getPixelForValue(val);
                                        
                                        // ç»˜åˆ¶è™šçº¿
                                        ctx.strokeStyle = color;
                                        ctx.lineWidth = 1;
                                        ctx.setLineDash([5, 5]);
                                        ctx.beginPath();
                                        ctx.moveTo(left, yPos);
                                        ctx.lineTo(right, yPos);
                                        ctx.stroke();
                                        ctx.setLineDash([]);
                                        
                                         // è®¾ç½®æ ‡ç­¾æ–‡æœ¬
                                        const text = isMobile ? `${val.toFixed(1)}` : ` ${label}: ${val.toFixed(2)} `;
                                        ctx.font = isMobile ? 'bold 10px monospace' : 'bold 13px monospace';
                                        const textWidth = ctx.measureText(text).width;
                                        const textHeight = isMobile ? 16 : 22;
                                        
                                        // æ™ºèƒ½é¿è®©é€»è¾‘ï¼šå¦‚æœç¦»é¡¶éƒ¨å¤ªè¿‘ï¼Œæ ‡ç­¾å‘ä¸‹æ˜¾ç¤º
                                        const labelY = yPos < 30 ? yPos + 2 : yPos - (isMobile ? 8 : 11);

                                        // å°†æ ‡ç­¾æ”¾ç½®åœ¨å³è¾¹è·åŒºåŸŸï¼Œç¦»å›¾è¡¨è¾¹ç¼˜ 5px
                                        const labelX = right + 5; 
                                        
                                        // 1. ç»˜åˆ¶å®å¿ƒèƒŒæ™¯è‰²å— (çº¢è‰²æˆ–ç»¿è‰²)
                                        ctx.fillStyle = color;
                                        // ç»˜åˆ¶åœ†è§’çŸ©å½¢èƒŒæ™¯
                                        ctx.beginPath();
                                        const radius = 5;
                                        const x = labelX, y_rect = labelY, w = textWidth, h = textHeight;
                                        ctx.moveTo(x + radius, y_rect);
                                        ctx.lineTo(x + w - radius, y_rect);
                                        ctx.quadraticCurveTo(x + w, y_rect, x + w, y_rect + radius);
                                        ctx.lineTo(x + w, y_rect + h - radius);
                                        ctx.quadraticCurveTo(x + w, y_rect + h, x + w - radius, y_rect + h);
                                        ctx.lineTo(x + radius, y_rect + h);
                                        ctx.quadraticCurveTo(x, y_rect + h, x, y_rect + h - radius);
                                        ctx.lineTo(x, y_rect + radius);
                                        ctx.quadraticCurveTo(x, y_rect, x + radius, y_rect);
                                        ctx.closePath();
                                        ctx.fill();
                                        
                                        // 2. ç»˜åˆ¶ç™½è‰²æ–‡å­—
                                        ctx.fillStyle = '#FFFFFF';
                                        ctx.textAlign = 'left';
                                        ctx.textBaseline = 'top';
                                        ctx.fillText(text, labelX, labelY + 3);
                                        
                                        // 3. è¡¥å……ä¸€æ®µè™šçº¿å°†å›¾è¡¨çº¿å¼•å¯¼è‡³æ ‡ç­¾
                                        ctx.strokeStyle = color;
                                        ctx.setLineDash([2, 2]);
                                        ctx.beginPath();
                                        ctx.moveTo(right, yPos);
                                        ctx.lineTo(labelX, yPos);
                                        ctx.stroke();
                                        ctx.setLineDash([]);
                                    };


                                    drawLabel(maxPrice, 'rgba(239, 68, 68, 0.8)', 'H');
                                    drawLabel(minPrice, 'rgba(34, 197, 94, 0.8)', 'L');
                                }
                            }]
                        });
                    });
                },

                updateChartData(newData) {
                    if (!this.chartInstance) return;
                    
                    // å°†æ–°ç‚¹åŠ å…¥ historyData ä¾› processDataForChart ä½¿ç”¨
                    this.historyData.push(newData);
                    
                    // é‡æ–°è®¡ç®—å¹¶å…¨é‡æ›´æ–°
                    const chartData = this.processDataForChart(this.historyData);
                    this.chartInstance.data.datasets[0].data = chartData;
                    
                    this.chartInstance.update('none'); 
                }
            },
            mounted() {
                // åˆå§‹åŒ–åŠ è½½
                this.fetchHistory();
                this.fetchRecords();
                this.fetchSettings();
                this.fetchPrice();
                
                // å®šæ—¶åˆ·æ–°
                this.timer = setInterval(this.fetchPrice, 5000);

                // å“åº”å¼ç›‘å¬
                window.addEventListener('resize', this.handleResize);
            },
            beforeUnmount() {
                if (this.timer) clearInterval(this.timer);
                window.removeEventListener('resize', this.handleResize);
                if (this.chartInstance) {
                    this.chartInstance.destroy();
                    this.chartInstance = null;
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
